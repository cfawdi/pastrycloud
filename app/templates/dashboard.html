{% extends "base.html" %}
{% block title %}Dashboard - {{ shop_name }}{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <!-- Stock Value -->
  <div class="stat bg-base-200 rounded-box shadow">
    <div class="stat-figure text-primary">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
      </svg>
    </div>
    <div class="stat-title">Stock Value</div>
    <div class="stat-value text-primary text-2xl">{{ "%.2f"|format(stock_value) }} {{ currency }}</div>
    <div class="stat-desc">Total inventory value</div>
  </div>

  <!-- Low Stock -->
  <div class="stat bg-base-200 rounded-box shadow">
    <div class="stat-figure text-warning">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
    </div>
    <div class="stat-title">Low Stock Alerts</div>
    <div class="stat-value text-warning text-2xl">{{ low_stock|length }}</div>
    <div class="stat-desc">Items need restocking</div>
  </div>

  <!-- Today's Sales -->
  <div class="stat bg-base-200 rounded-box shadow">
    <div class="stat-figure text-success">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
      </svg>
    </div>
    <div class="stat-title">Today's Sales</div>
    <div class="stat-value text-success text-2xl">{{ "%.2f"|format(today_sales) }} {{ currency }}</div>
    <div class="stat-desc">{{ today_sales_count }} transaction{{ 's' if today_sales_count != 1 }}</div>
  </div>

  <!-- Today's Production -->
  <div class="stat bg-base-200 rounded-box shadow">
    <div class="stat-figure text-secondary">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
      </svg>
    </div>
    <div class="stat-title">Production Runs</div>
    <div class="stat-value text-secondary text-2xl">{{ today_production }}</div>
    <div class="stat-desc">Runs started today</div>
  </div>
</div>

<!-- Charts + Alerts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
  <!-- Sales Chart -->
  <div class="card bg-base-200 shadow lg:col-span-2">
    <div class="card-body">
      <h3 class="card-title text-base">Sales - Last 7 Days</h3>
      <canvas id="salesChart" height="120"></canvas>
    </div>
  </div>

  <!-- Top Products -->
  <div class="card bg-base-200 shadow">
    <div class="card-body">
      <h3 class="card-title text-base">Top Products (30d)</h3>
      {% if top_product_labels %}
      <canvas id="topProductsChart" height="200"></canvas>
      {% else %}
      <div class="flex items-center justify-center h-32 text-base-content/40">
        <p>No sales data yet</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Low Stock Alerts + Recent Activity -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Low Stock Alerts -->
  <div class="card bg-base-200 shadow">
    <div class="card-body">
      <h3 class="card-title text-base">
        Low Stock Alerts
        {% if low_stock %}
        <span class="badge badge-warning">{{ low_stock|length }}</span>
        {% endif %}
      </h3>
      {% if low_stock %}
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr><th>Ingredient</th><th>Stock</th><th>Min</th><th>Status</th></tr>
          </thead>
          <tbody>
            {% for ing in low_stock[:8] %}
            <tr>
              <td class="font-medium">{{ ing.name }}</td>
              <td>{{ ing.display_quantity }}</td>
              <td>{{ ing.display_min_stock }}</td>
              <td>
                {% if ing.stock_status == 'out' %}
                  <span class="badge badge-error badge-sm">Out</span>
                {% else %}
                  <span class="badge badge-warning badge-sm">Low</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if low_stock|length > 8 %}
      <a href="{{ url_for('ingredients.index', status='low') }}" class="link link-primary text-sm mt-2">View all {{ low_stock|length }} items</a>
      {% endif %}
      {% else %}
      <div class="flex items-center justify-center h-24 text-success/60">
        <p>All stock levels are healthy</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="card bg-base-200 shadow">
    <div class="card-body">
      <h3 class="card-title text-base">Recent Activity</h3>
      <div class="space-y-3">
        {% for sale in recent_sales %}
        <div class="flex items-center gap-3 text-sm">
          <div class="badge badge-success badge-xs"></div>
          <div class="flex-1">
            <span class="font-medium">Sale #{{ sale.id }}</span>
            <span class="opacity-60"> - {{ "%.2f"|format(sale.total_amount) }} {{ currency }}</span>
          </div>
          <span class="text-xs opacity-50">{{ sale.created_at.strftime('%H:%M') }}</span>
        </div>
        {% endfor %}
        {% for run in recent_production %}
        <div class="flex items-center gap-3 text-sm">
          <div class="badge badge-secondary badge-xs"></div>
          <div class="flex-1">
            <span class="font-medium">{{ run.recipe.name }}</span>
            <span class="opacity-60"> - {{ run.status }}</span>
          </div>
          <span class="text-xs opacity-50">{{ run.created_at.strftime('%H:%M') }}</span>
        </div>
        {% endfor %}
        {% if not recent_sales and not recent_production %}
        <div class="flex items-center justify-center h-24 text-base-content/40">
          <p>No recent activity</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Waste summary -->
{% if waste_cost > 0 %}
<div class="mt-6">
  <div class="alert alert-warning shadow-sm">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
    </svg>
    <span>Waste cost this month: <strong>{{ "%.2f"|format(waste_cost) }} {{ currency }}</strong></span>
    <a href="{{ url_for('waste.index') }}" class="btn btn-sm btn-ghost">View Details</a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sales trend chart
  const salesCtx = document.getElementById('salesChart');
  if (salesCtx) {
    new Chart(salesCtx, {
      type: 'line',
      data: {
        labels: {{ chart_labels|tojson }},
        datasets: [{
          label: 'Sales ({{ currency }})',
          data: {{ chart_data|tojson }},
          borderColor: '#D97706',
          backgroundColor: 'rgba(217, 119, 6, 0.1)',
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#D97706',
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: v => v + ' {{ currency }}' } }
        }
      }
    });
  }

  // Top products chart
  {% if top_product_labels %}
  const topCtx = document.getElementById('topProductsChart');
  if (topCtx) {
    new Chart(topCtx, {
      type: 'doughnut',
      data: {
        labels: {{ top_product_labels|tojson }},
        datasets: [{
          data: {{ top_product_data|tojson }},
          backgroundColor: ['#D97706', '#7C3AED', '#10B981', '#F59E0B', '#EF4444'],
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } }
        }
      }
    });
  }
  {% endif %}
});
</script>
{% endblock %}
